<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.activiti.org/test">
  <process id="myProcess" name="My process" isExecutable="true">
    <startEvent id="startevent1" name="Start"></startEvent>
    <sequenceFlow id="flow1" name="Nouvelle alerte ?" sourceRef="startevent1" targetRef="scripttask1">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${context.result != null}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="flow2" sourceRef="scripttask1" targetRef="inclusivegateway1"></sequenceFlow>
    <serviceTask id="mailtask1" name="Notification alerte mail" activiti:type="mail">
      <extensionElements>
        <activiti:field name="to">
          <activiti:expression><![CDATA[${user.username}]]></activiti:expression>
        </activiti:field>
        <activiti:field name="subject">
          <activiti:expression><![CDATA[${titre}]]></activiti:expression>
        </activiti:field>
        <activiti:field name="html">
          <activiti:expression><![CDATA[<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	</head>
	
	<body style="margin:0;padding:0;font-family:Arial,sans-serif;font-size:14px;line-height:1.42857142857143;background:#f5f5f5;color:#333;">
		
		  <div class="aui-header aui-dropdown2-trigger-group" role="navigation" style="background:#205081;border-bottom:1px solid #2e3d54;-moz-box-sizing:border-box;box-sizing:border-box;color:#fff;padding:0 10px;height:45px">
		  	<table style="width:100%">
		  		<tr>
		  			<td style="width:50%;">
		  				<a href="https://www.jdevops.com/smarthome/" style="-moz-box-sizing:border-box;box-sizing:border-box;height:40px;padding:0 10px; color:#fff;display:inline;line-height:1;text-decoration:none;">			
				        	<span class="logoTextHeader" style="font-weight:bold;text-decoration:none;">BeMyHomeSmart</span>
			        	</a>
		  			</td>
		  			<td style="width:50%; text-align:right">
		  				<a href="https://www.jdevops.com/smarthome/" class="aui-button aui-button-primary" style="background:#3572b0;border-color:transparent;color:#fff;font-weight:700;-webkit-font-smoothing:antialiased;-moz-box-sizing:border-box;box-sizing:border-box;border-radius:3.01px;cursor:pointer;display:inline-block;font-family:inherit;font-size:14px;font-variant:normal;height:2.14285714em;line-height:1.42857143;margin-top:-6px;padding:4px 10px;text-decoration:none;white-space:nowrap">Connexion</a>
		  			</td>
		  		</tr>
		  	</table>
		  </div>
		
		
		<div id="content" role="main" style="width:100%;-moz-box-sizing:border-box;box-sizing:border-box;clear:both;position:relative; margin-top:20px">
			<div class="aui-page-panel" style="border-radius:5px;border-width:1px;margin-left:auto;margin-right:auto;width:800px;background:#fff;border:1px solid #ccc;-moz-box-sizing:border-box;box-sizing:border-box;clear:both;display:block;position:relative;"">
				<div class="aui-page-panel-inner" style="border-spacing:0;display:table;table-layout:fixed;width:100%">
					<div style="-moz-box-sizing:border-box;box-sizing:border-box;display:table-cell;padding:20px;vertical-align:top">
						<h1 style="color:#333;font-size:32px;font-weight:400;line-height:1.25;text-transform:none;">${alert.level.toString().toUpperCase()} ${device.label}</h1>
					
						<p>Bonjour,</p>
						<br/>
						
						<p>Une alerte <b>${alert.level.toString().toUpperCase()}</b> est déclenchée sur l'objet <b>${device.label}</b> depuis <b>${dateAlert}</b> </p>
						
						<p>Vous pouvez arrêter l'envoi de ce message <a href="https://www.jdevops.com/smarthome/deviceAlert/deviceAlerts?open=true">en approuvant les alertes en cours</a>.</p>
						
						<br/>
						<p>Merci</p>
						<p>L'équipe BeMyHomeSmart</p>
					</div>
				</div>
			</div>
		</div>
		
		
		
		<div style="font-size: small;text-align: center;width:100%;">
			<h6 style="color:#707070;font-size:10px;font-weight:700;line-height:1.66666667;text-transform:uppercase;margin:20px 0 0">ELLEOUET GREGORY
			<br/>
			Java Development Operations
			<br/>
			Mail <a href="mailto:contact@jdevops.com" style="text-decoration:none;">contact@jdevops.com</a> - Twitter <a href="https://twitter.com/gelleouet">@gelleouet</a>
			</h6>
		</div>
		
	</body>
</html>]]></activiti:expression>
        </activiti:field>
        <activiti:field name="bcc">
          <activiti:string><![CDATA[contact@jdevops.com]]></activiti:string>
        </activiti:field>
      </extensionElements>
    </serviceTask>
    <sequenceFlow id="flow3" name="Notification mail ?" sourceRef="inclusivegateway1" targetRef="mailtask1">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${alertLevel.notifMail}]]></conditionExpression>
    </sequenceFlow>
    <endEvent id="endevent1" name="End"></endEvent>
    <sequenceFlow id="flow4" name="Fin" sourceRef="mailtask1" targetRef="endevent1"></sequenceFlow>
    <scriptTask id="scripttask1" name="Préparation des données" scriptFormat="groovy" activiti:autoStoreVariables="false">
      <script>def alert = smarthome.automation.DeviceAlert.read(context.result.id)
def device = alert.device
def user = smarthome.security.User.read(device.user.id)
def alertLevel = smarthome.automation.DeviceLevelAlert.findByDeviceAndLevel(device, alert.level)

String dateAlert = alert.dateDebut.format(smarthome.core.DateUtils.FORMAT_DATETIME_USER)
String titre = "${alert.level.toString().toUpperCase()} ${device.label} ${dateAlert}"

if (alert.relance) {
	titre += " - relance ${alert.relance}"
}
	
execution.setVariable("alert", alert)
execution.setVariable("user", user)
execution.setVariable("alertLevel", alertLevel)
execution.setVariable("device", device)
execution.setVariable("titre", titre)
execution.setVariable("dateAlert", dateAlert)

</script>
    </scriptTask>
    <endEvent id="endevent2" name="End"></endEvent>
    <sequenceFlow id="flow5" name="Aucune notification : fin" sourceRef="inclusivegateway1" targetRef="endevent2"></sequenceFlow>
    <scriptTask id="scripttask2" name="Notification alerte SMS" scriptFormat="groovy" activiti:autoStoreVariables="false">
      <script>StringBuilder message = new StringBuilder()
message &lt;&lt; "Alerte monitoring sondes\n"
for (def sonde : sondeSms) {
	message &lt;&lt; "- ${sonde.libelle} : ${sonde.lastValue.format(lims.core.DateUtils.FORMAT_DATETIME_USER)} (fréquence : ${sonde.frequence}min)\n"
}

lims.core.Notification notification = new lims.core.Notification(
	message: message.toString(), destinataires: userSms, expediteur: "LIMSLBO"
)

smsNotificationService.sendNotification(notification)</script>
    </scriptTask>
    <sequenceFlow id="flow6" name="Notification SMS ?" sourceRef="inclusivegateway1" targetRef="scripttask2">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${alertLevel.notifSms && user.telephoneMobile != null}]]></conditionExpression>
    </sequenceFlow>
    <endEvent id="endevent3" name="End"></endEvent>
    <sequenceFlow id="flow7" name="Fin" sourceRef="scripttask2" targetRef="endevent3"></sequenceFlow>
    <inclusiveGateway id="inclusivegateway1" name="Inclusive Gateway"></inclusiveGateway>
    <textAnnotation id="textannotation1">
      <text>Workflow : Device Monitoring Alert</text>
    </textAnnotation>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_myProcess">
    <bpmndi:BPMNPlane bpmnElement="myProcess" id="BPMNPlane_myProcess">
      <bpmndi:BPMNShape bpmnElement="startevent1" id="BPMNShape_startevent1">
        <omgdc:Bounds height="35.0" width="35.0" x="343.0" y="70.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="mailtask1" id="BPMNShape_mailtask1">
        <omgdc:Bounds height="55.0" width="161.0" x="170.0" y="360.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="endevent1" id="BPMNShape_endevent1">
        <omgdc:Bounds height="35.0" width="35.0" x="233.0" y="470.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="scripttask1" id="BPMNShape_scripttask1">
        <omgdc:Bounds height="55.0" width="231.0" x="245.0" y="150.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="endevent2" id="BPMNShape_endevent2">
        <omgdc:Bounds height="35.0" width="35.0" x="130.0" y="260.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="scripttask2" id="BPMNShape_scripttask2">
        <omgdc:Bounds height="55.0" width="161.0" x="400.0" y="360.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="endevent3" id="BPMNShape_endevent3">
        <omgdc:Bounds height="35.0" width="35.0" x="463.0" y="470.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="inclusivegateway1" id="BPMNShape_inclusivegateway1">
        <omgdc:Bounds height="40.0" width="40.0" x="340.0" y="257.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="textannotation1" id="BPMNShape_textannotation1">
        <omgdc:Bounds height="50.0" width="631.0" x="10.0" y="10.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="flow1" id="BPMNEdge_flow1">
        <omgdi:waypoint x="360.0" y="105.0"></omgdi:waypoint>
        <omgdi:waypoint x="360.0" y="150.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="80.0" x="369.0" y="119.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow2" id="BPMNEdge_flow2">
        <omgdi:waypoint x="360.0" y="205.0"></omgdi:waypoint>
        <omgdi:waypoint x="360.0" y="257.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow3" id="BPMNEdge_flow3">
        <omgdi:waypoint x="340.0" y="277.0"></omgdi:waypoint>
        <omgdi:waypoint x="250.0" y="277.0"></omgdi:waypoint>
        <omgdi:waypoint x="250.0" y="360.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="83.0" x="259.0" y="320.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow4" id="BPMNEdge_flow4">
        <omgdi:waypoint x="250.0" y="415.0"></omgdi:waypoint>
        <omgdi:waypoint x="250.0" y="470.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="14.0" x="258.0" y="429.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow5" id="BPMNEdge_flow5">
        <omgdi:waypoint x="340.0" y="277.0"></omgdi:waypoint>
        <omgdi:waypoint x="165.0" y="277.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="42.0" width="100.0" x="181.0" y="240.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow6" id="BPMNEdge_flow6">
        <omgdi:waypoint x="380.0" y="277.0"></omgdi:waypoint>
        <omgdi:waypoint x="480.0" y="277.0"></omgdi:waypoint>
        <omgdi:waypoint x="480.0" y="360.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="87.0" x="489.0" y="320.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="flow7" id="BPMNEdge_flow7">
        <omgdi:waypoint x="480.0" y="415.0"></omgdi:waypoint>
        <omgdi:waypoint x="480.0" y="470.0"></omgdi:waypoint>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="14.0" width="14.0" x="490.0" y="429.0"></omgdc:Bounds>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>